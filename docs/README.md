# Jobs-Housing Balance Mod

## Технические требования (Technical Requirements)
- **Целевая версия**: Cities: Skylines (Original), не Cities: Skylines II
- **UI Framework**: ColossalFramework.UI (нативный для совместимости)
- **Обновление данных**: Периодическое (5-10 секунд)
- **Совместимость**: Realistic Population, TM:PE, RICO

# Зачем (Goal)

Дать игроку простой, наглядный индикатор дисбаланса «жильё ↔ рабочие места», чтобы быстро решать, **в каких секторах города добавлять жильё, а где — рабочие места**. Карта подсвечивает участки, где фактических жителей больше, чем мест работы (нужны jobs), и наоборот (нужно housing).

# Результат (What the user sees)

- Переключаемый слой-оверлей:
    
    - **Hex grid** (гексагональная сетка) с несколькими преднастройками масштаба (см. ниже).
        
    - **Districts** (по районам).
        
- Цветовая легенда:
    
    - Красный: _избыток жителей / нехватка рабочих мест_ (jobs < residents).
        
    - Синий: _избыток рабочих мест / нехватка жилья_ (jobs > residents).
        
    - Интенсивность = |jobs − residents|, нормированная внутри текущего режима.
        
- Текстовые метки на гексах/районах:
    
    - Показывают числовое значение разницы `jobs - residents`
        
    - Положительные значения (синий): "+250" → нужно housing
        
    - Отрицательные значения (красный): "-180" → нужно jobs
        
- Мини-панель управления:
    
    - [Mode] Hex / Districts
        
    - [Hex size] 64 / 128 / 256 (и т. п. — см. ниже про трактовку)
        
    - [Opacity] ползунок
        
    - [Legend] короткая подсказка значений
        

> Специально: **без таблиц и экспорта** — только полезная визуализация.

# Что именно считаем (Scope)

Быстрый и надёжный вариант — считать **фактическое состояние**, а не «емкость»:

- **Residents (housing фактически)** — количество реально живущих граждан в зданиях (по `CitizenUnits`типа Home).
    
- **Jobs (фактически занятые)** — количество реально работающих граждан (по `CitizenUnits` типа Work) в нежилых зданиях (коммерция/офисы/индустрия/сервисы).
    
- **Balance** = `jobs − residents` на каждой ячейке гекса (или в районе).
    
    - `> 0` (синий): рабочих мест больше, чем жильцов рядом → добавляй жильё.
        
    - `< 0` (красный): жильцов больше, чем рабочих мест → добавляй jobs (офис/коммерция/индустрия).
        

Почему так: это устойчиво к модам вроде **Realistic Population** — он меняет ёмкости зданий, но мы берём **факт заселения/занятости**. Если захочешь позже — добавим второй режим «capacity vs fact».

# Совместимость

- **Realistic Population**: работает «как есть», счёт идёт по фактическим юнитам, без рефлексии в его внутренности.
    
- **TM:PE / RICO**: read-only; мод ничего не патчит и не меняет. Только читает игру (и RICO никак не ломает логику — рабочие также учитываются по факту).
    

# Единицы сетки (Hex) и пресеты

Чтобы не путать «64×64» (у квадратной сетки — это число ячеек в строке/столбце), договоримся:

- В UI показываем **размер гекса** как «примерный диаметр» в игровых метрах, а преднастройки называем знакомо:
    
    - **Hex size: 64 / 128 / 256** — трактуем как ~диаметр гекса в _клетках условной сетки_ (проще — в метрах: 64м/128м/256м эквивалент).
        
    - Внутри — рассчитываем радиус `r = size / 2`, строим **pointy-top** гексагоны (аксиальные координаты q,r) и заполняем карту.
        
- В режиме **Districts** hex-контролы скрываем.
    

# Архитектура (Components)

1. **DataCollector**
    
    - Проход по `BuildingManager.m_buildings` → обход связанного списка `CitizenUnits`.
        
    - Считаем: `residents` (Home), `jobs` (Work), позицию здания, номер района.
        
2. **AggregatorHex** / **AggregatorDistricts**
    
    - Hex: преобразуем позицию `Vector3(x,z)` → аксиальные координаты (q,r), суммируем `residents/jobs` в ячейке.
        
    - Districts: агрегируем по `byte districtId`.
        
3. **Normalizer**
    
    - Считает локальный `maxAbs = max(|jobs − residents|)` для текущего режима → даёт коэффициент насыщенности цвета.
        
4. **OverlayRenderer**
    
    - Рисует гексагоны/заливки районов полу-прозрачным цветом (GL/OverlayEffect).
        
    - Подписывает легенду/подсказку под курсором (diff и оценку).
        
5. **UI Panel**
    
    - Переключатели режима, размер гекса, непрозрачность, кнопка «вкл/выкл слой».
        

# Алгоритм (Hex, кратко)

- Выбираем **pointy-top** гекс-сетку с мировым шагом `size` (примерно диаметр).
    
- Перевод координат в аксиальные:
    
    - `q = (sqrt(3)/3 * x - 1/3 * z) / r`
        
    - `r = (2/3 * z) / r`
        
    - После чего **округление в ближайший гекс** (cube rounding).
        
- Храним словарь `Map<(q,r) -> (residents, jobs)>`.
    
- Баланс по ячейке: `diff = jobs − residents`.
    

# Цветовая шкала (простая и ясная)

- Вычислить `maxAbs = max(|diff|)` по видимым ячейкам.
    
- Насыщенность `t = clamp(|diff| / maxAbs)`.
    
- Цвет:
    
    - `diff > 0`: **синий** с альфой `α = baseα * t`.
        
    - `diff < 0`: **красный** с альфой `α = baseα * t`.
        
    - `diff = 0`: не рисуем (или очень слабая нейтральная заливка).
        
- Отдельный ползунок **Opacity** масштабирует финальную альфу.
    

# UI (минимум, без лишнего)

- Dropdown **Mode**: `Hex | Districts`.
    
- Dropdown **Hex size**: `64 | 128 | 256 | 512` (при Districts — disabled).
    
- Slider **Opacity**: `0.1 … 0.8`.
    
- Static **Legend**: “красный — нужно jobs, синий — нужно housing”.
    

# Производительность

- Пересчёт раз в **N игровых секунд** (например, 5–10 с) или по событию «здание построено/снесено» (по желанию).
    
- Кэшируем:
    
    - список сэмплов зданий (пересобираем реже);
        
    - словарь **(q,r)** → суммы для гексов текущего размера (пересчитываем только при смене размера).
        
- Отрисовка: пачками, минимизируем вызовы GL.
    

# Пограничные случаи и решения

- **Пустые ячейки**: не рисуем.
    
- **Один гигантский завод в малом гексе**: допустимо — так и нужно подсветить, что районам вокруг «не хватает» жителей. Если шумит — можно добавить медианный фильтр сглаживания в настройках (позже).
    
- **Водоёмы/карта вне города**: ячейки без зданий остаются пустыми.
    

# Тест-план (коротко)

1. Малый город: одна индустрия + один спальный район → проверяем, что индустрия синяя (jobs>residents), спальник красный (residents>jobs).
    
2. Добавляем линию метро между ними → через 5–10 с значения балансируются (но могут остаться различия локально — это нормально, мы считаем факт).
    
3. Смена Hex size: картина агрегируется, но «общий рисунок» сохраняется.
    
4. Переключение Districts: цифры и тон примерно соответствуют сумме гексов внутри района.
    

# Дорожная карта (после MVP)

- **Capacity mode** (опционально): второй слой, где `jobs_capacity − residents_capacity` (важно именно с Realistic Population).
    
- **Сглаживание** (kernel/median) и маски (исключать парки/воду).
    
- **Коммьют-изохроны**: объяснить дисбалансы доступностью (мод №2 из набора).
    

# «Готово/Не готово» (Acceptance)

-  Оверлей **Hex/Districts** переключается, рендер без артефактов.
    
-  Счёт residents/jobs по факту (CitizenUnits) корректен (ручная проверка нескольких зданий).
    
-  Цвета интуитивны: «красный — добавить jobs», «синий — добавить housing».
    
-  Пересчёт не лагирует (60 FPS на типичном городе при hex size ≥128).
    
-  Совместимость: запускается при установленном Realistic Population, TM:PE, RICO.