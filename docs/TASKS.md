# Задачи проекта (Project Tasks)

## Правила разработки (Development Rules)

- **Целевая версия игры**: Cities: Skylines (Original) — не Cities: Skylines II
- **UI Framework**: ColossalFramework.UI (нативный фреймворк игры для максимальной совместимости)
- **Обновление данных**: Только периодическое обновление (каждые 5-10 секунд), без хуков на события строительства
- **Совместимость**: Мод должен работать с популярными модами (Realistic Population, TM:PE, RICO) без конфликтов
- **Tooltip**: Не реализуется на данный момент

## Окружение разработки (Development Environment)

- **OS**: macOS
- **Framework**: Mono framework для разработки
- **IDE**: Cursor (VS Code fork)

## MVP: Минимальная рабочая версия с логом на событие загрузки карты

Цель: Реализовать минимальный мод, который логирует событие загрузки карты в консоль игры.

### Необходимые шаги для MVP:

1. **Базовая структура мода** (из Task 1)
   - Создать точку входа мода (entry point): создать класс, наследующий `LoadingExtensionBase` или реализующий `IModContainer`
   - Настроить metadata мода: AssemblyInfo, modInfo, зависимости
   - Добавить необходимые references: ColossalFramework.dll, Cities.dll, возможно Harmony если нужно
   - Инициализировать мод при загрузке игры

2. **Обработчик события загрузки карты**
   - Подписаться на событие загрузки карты (например, `LoadingManager.instance.m_metaData.m_updateMode == UpdateMode.LoadGame`)
   - Альтернативно использовать событие `LevelLoaded` 
   - В обработчике добавить простой Debug.Log вывод в консоль игры

3. **Минимальная инициализация**
   - В обработчике события инициализировать основные компоненты мода
   - Пока без UI — просто логирование

4. **Тестирование**
   - Собрать мод, установить в папку модов игры
   - Загрузить сохранение города и проверить консоль на наличие лога

### Порядок задач из TASKS.md для MVP:

- **Task 1 (частично)**: Создать базовую структуру мода и конфигурацию
  - Точка входа мода
  - Базовая инициализация
  - Простое логирование
  
- **Task 9-10 (пока не нужно)**: UI элементы можно добавить позже, пока достаточно простого лога в консоль для отладки

### Что НЕ нужно для MVP:

- Task 2: Утилиты для гексов
- Task 3: Сбор данных
- Task 4-5: Агрегация
- Task 7: Рендеринг
- Task 8: Контроллер/менеджер
- Полноценный UI

## Основные задачи инфраструктуры

### 1. Базовая структура и конфигурация мода
- Создать базовую структуру мода (metadata, AssemblyInfo, mod entry point)
- Настроить Harmony патчи для перехвата рендеринга (если необходимо)
- Определить конфигурационные параметры (размеры hex, цвета, частота обновления, размещение UI)
- Реализовать сохранение/загрузку настроек
- Инициализировать ColossalFramework.UI для создания нативных UI элементов

### 2. Утилиты для работы с гексами
- Реализовать систему координат для гексагональной сетки (аксиальные координаты q,r)
- Добавить функции конвертации координат: world → hex (pointy-top, мировые координаты)
- Реализовать алгоритм округления до ближайшего гекса (cube rounding) для преобразования world позиций в hex ячейки
- Добавить обратное преобразование hex → world для рендеринга

### 3. Модуль сбора данных
- Реализовать обход BuildingManager для получения всех зданий
- Подсчитывать количество жителей (CitizenUnits типа Home) на здание
- Подсчитывать количество рабочих мест (CitizenUnits типа Work) на здание
- Получать позицию здания и ID района
- Хранить собранные данные в удобной структуре

### 4. Агрегация по гексам
- Реализовать модуль AggregatorHex:
  - Распределять здания по hex ячейкам по их world позиции
  - Суммировать residents/jobs внутри каждой hex ячейки
  - Рассчитывать разницу `diff = jobs - residents` для каждой ячейки
  - Хранить результаты в словаре Map<(q,r), (residents, jobs, diff)>
  - Пересчитывать при обновлении данных

### 5. Агрегация по районам
- Реализовать модуль AggregatorDistricts:
  - Группировать здания по districtId
  - Суммировать residents/jobs внутри каждого района
  - Рассчитывать разницу `diff = jobs - residents` для каждого района
  - Хранить результаты в Map<districtId, (residents, jobs, diff)>

### 6. Нормализация и цветовое кодирование
- Рассчитывать максимальное абсолютное значение разности для текущего режима
- Вычислять коэффициент насыщенности t = |diff| / maxAbs
- Применять цветовое кодирование: положительные значения (синий), отрицательные (красный)
- Применять глобальную непрозрачность

### 7. Система рендеринга оверлея
- Реализовать OverlayRenderer:
  - Рендеринг hex ячеек (GL/OverlayEffect)
  - Рендеринг районов
  - Отрисовка с правильным цветом и прозрачностью
  - Отображение текстовых меток на каждом гексе/районе (показывает `jobs - residents`)
  - Обработка границ видимости камеры
  - Оптимизация отрисовки текста (могут показываться только для достаточно больших значений)

### 8. Главный контроллер/менеджер
- Создать контроллер для управления:
  - Переключение режимов (Hex/Districts)
  - Периодическое обновление данных (каждые 5-10 секунд игрового времени)
  - Управление кэшем
  - Триггеры обновления при изменении размера hex
  - Связь между UI, DataCollector, Aggregators и Renderer

### 9. UI элементы управления
- Создать dropdown для выбора режима (Hex/Districts)
- Создать dropdown для выбора размера hex (64/128/256/512; disabled при Districts)
- Создать slider для непрозрачности (0.1-0.8)
- Добавить легенду/подсказку с объяснением цветов
- Добавить кнопку включения/выключения слоя

### 10. Интеграция UI панели
- Создать и зарегистрировать UI панель в игре
- Расположить элементы управления из задачи 9
- Связать состояние с рендерингом через контроллер
- Реализовать логику показа/скрытия панели
- Создать жизненный цикл (OnCreate, OnDestroy, OnUpdate)

## Дополнительные задачи

### 11. Оптимизация производительности
- Кэшировать список зданий между обновлениями
- Кэшировать агрегированные данные по hex при изменении размера
- Оптимизировать вызовы отрисовки GL
- Добавить culling для невидимых элементов

### 12. Тестирование и валидация
- Проверить работу на малых городах
- Сверить подсчеты с данными игры
- Провести тестирование производительности на больших городах
- Проверить совместимость с Realistic Population, TM:PE, RICO

### 13. Доводка и граничные случаи
- Обработать пустые ячейки (не рисовать)
- Обработать районы без ID (districtId = 0)
- Обработать пустые районы (без зданий)

