# Задачи проекта - Текущий прогресс

> **Примечание**: Для информации о разработке см. [DEVELOPMENT.md](DEVELOPMENT.md)  
> **Примечание**: Для уроков разработки см. [LESSONS_LEARNED.md](LESSONS_LEARNED.md)  
> **Примечание**: Для будущих задач см. [FUTURE_TASKS.md](FUTURE_TASKS.md)

## MVP: Базовая структура мода (Basic Mod Structure) ✅

Цель: Реализовать минимальный мод, который логирует событие загрузки карты в консоль игры и инициализируется при запуске.

### Детальный план подзадач:

#### 1. Настройка проекта (.csproj) ✅
- [x] Создан `.csproj` файл для .NET Framework 3.5 (совместим с Cities: Skylines)
- [x] Добавлены ссылки на необходимые DLL
- [x] Настроены пути к DLL в `<HintPath>` элементах
- [特殊] Указан OutputPath для сборки в папку модов
- [x] Добавлен CitiesHarmony.dll

#### 2. Metadata мода ✅
- [x] Создан файл `Properties/AssemblyInfo.cs`
- [x] Установлены атрибуты качества кода

#### 3. Точка входа мода (Entry Point) ✅
- [x] Создан класс `JobsHousingBalanceMod` в корне `src/`
- [x] Реализован интерфейс `ICities.IUserMod`

#### 4. Инициализация Harmony ✅
- [x] Добавлены references на CitiesHarmony.dll
- [x] Создан класс `HarmonyPatcher` в `src/Utils/`
- [x] Применены патчи в `OnEnabled()`

#### 5. Обработчик загрузки игры ✅
- [x] Создан класс `LoadingExtension` наследующий `LoadingExtensionBase`
- [x] Реализованы методы `OnLevelLoaded()` и `OnLevelUnloading()`

#### 6. Регистрация мода ✅
- [x] `LoadingExtension` автоматически обнаруживается игрой

#### 7. Тестовая сборка и установка ✅
- [x] Собран проект с помощью msbuild
- [x] DLL создан в OutputPath
- [x] Проверка в игре: мод появился в списке модов

#### 8. Тестирование в игре ✅
- [x] Мод появился в Content Manager → Mods
- [x] Мод успешно загружается при старте игры
- [x] Логи показывают работу мода

### Критерии завершения MVP:
✅ Мод появляется в списке модов игры  
✅ Мод корректно загружается при старте игры  
✅ Логи показывают работу мода  
✅ Мод не вызывает ошибок или крашей  
✅ Базовая структура готова для добавления UI и функционала

**Статус:** Все задачи MVP (Tasks 1-8) **ЗАВЕРШЕНЫ**

## Task 9: Круглая кнопка-иконка и UI панель

### Общее описание задачи

Необходимо создать круглую кнопку-иконку на экране, которая должна быть:
1. **Перетаскиваемая** - пользователь может перемещать кнопку по экрану
2. **Кликабельная** - при клике открывает UI панель с элементами управления
3. **Сохранение позиции** - после перезагрузки игры позиция кнопки сохраняется

### Подзадачи

#### 9.1 Создание круглой кнопки-иконки ✅
**Цель:** Создать визуальную круглую кнопку с иконкой на экране

**Детали:**
- [x] Создать класс `IconButton` наследующий от `UIButton` (ColossalFramework.UI) ✅
- [x] Определить размер кнопки (48x48 пикселей) ✅
- [x] Установить круглую форму кнопки с программно созданным фоном ✅
- [x] Добавить иконку из PNG файла, загружаемого из embedded resources ✅
- [x] Разместить кнопку в начальной позиции (правый верхний угол с отступом 300px) ✅
- [x] Добавить круглый фон с обводкой для видимости на любом фоне ✅

**Файлы:** `src/UI/IconButton.cs`

**Технические детали:**
- Использовать `ColossalFramework.UI.UIButton`
- Использовать `UITextureSprite` для рендеринга без атласов (избегает артефактов)
- PNG иконка загружается из embedded resources через `Assembly.GetManifestResourceStream`
- Фон создаётся программно как круглая текстура 48x48 с заполнением и границей
- Создать в `OnLevelLoaded` метода `LoadingExtension`
- Добавить кнопку в `UIView` игрового интерфейса

**Примечание:** Создан класс `IconButton` с размером 48x48 пикселей, размещённый в правом верхнем углу экрана. Кнопка имеет:
- Круглую форму с программно созданным фоном
- Цвет фона: #53555B (серо-синий)
- Цвет обводки: #508A33 (зелёный)
- Иконка 32x32 из PNG файла (icons8-demand-48.png) загружается из embedded resources
- Slimaticуется `UITextureSprite` для рендеринга фона и иконки без атласов
- Фон и иконка центрированы и правильно отображаются

Кнопка интегрирована в `LoadingExtension.OnLevelLoaded()` и автоматически создаётся при загрузке уровня.

#### 9.2 Реализация перетаскивания кнопки
**Цель:** Сделать кнопку перетаскиваемой мышью

**Детали:**
- [ ] Подписаться на события мыши (`OnMouseDown`, `OnMouseMove`, `OnMouseUp`)
- [ ] Сохранять смещение от позиции курсора до центра кнопки при начале перетаскивания
- [ ] Обновлять позицию кнопки во время перетаскивания
- [ ] Ограничить перемещение в пределах экрана (не выходить за границы)
- [ ] Обновлять позицию в реальном времени при движении мыши

**Файлы:** `src/UI/IconButton.cs` (расширить метод)

#### 9.3 Обработка кликов по кнопке
**Цель:** Реагировать на клик по кнопке (не во время перетаскивания)

**Детали:**
- [ ] Различать клик и перетаскивание
- [ ] Определять клик как `mouseDown -> mouseMove < threshold -> mouseUp`
- [ ] При клике вызвать метод открытия UI панели
- [ ] Игнорировать клик, если было перетаскивание

**Файлы:** `src/UI/IconButton.cs`

#### 9.4 Создание UI панели
**Цель:** Создать панель управления с элементами

**Детали:**
- [ ] Создать класс `MainPanel` наследующий от `UIComponent`
- [ ] Определить размер панели (например, 300x400 пикселей)
- [ ] Добавить фон панели с прозрачностью
- [ ] Добавить заголовок панели "Jobs-Housing Balance"
- [ ] Разместить панель по центру или в удобной позиции
- [ ] Добавить кнопку закрытия (X) в правом верхнем углу

**Файлы:** `src/UI/Panel/MainPanel.cs`

#### 9.5 Отображение/скрытие панели
**Цель:** Управлять видимостью панели по клику на кнопку

**Детали:**
- [ ] Хранить ссылку на `MainPanel` в `IconButton`
- [ ] При первом клике - создать и показать панель
- [ ] При повторном клике - скрыть панель
- [ ] При клике на кнопку закрытия - скрыть панель
- [ ] При скрытии не удалять панель, а только менять `isVisible`

**Файлы:** `src/UI/IconButton.cs`, `src/UI/Panel/MainPanel.cs`

#### 9.6 Сохранение позиции кнопки
**Цель:** Сохранять позицию кнопки между сессиями игры

**Детали:**
- [ ] При изменении позиции кнопки сохранять координаты
- [ ] Использовать `GameSettings.AddSettingsFile` для сохранения
- [ ] При загрузке уровня читать сохраненную позицию
- [ ] Если позиция не сохранена - использовать позицию по умолчанию

**Файлы:** `src/UI/IconButton.cs`, `src/Config/Settings.cs` (новый файл)

#### 9.7 Инициализация UI при загрузке уровня
**Цель:** Правильно инициализировать UI элементы при загрузке карты

**Детали:**
- [ ] В `LoadingExtension.OnLevelLoaded` создать экземпляр `IconButton`
- [ ] Добавить кнопку в `UIView` через `UIView.Find("UIView")?.AddUIComponent`
- [ ] Инициализировать позицию кнопки (загрузить из настроек или использовать дефолт)
- [ ] В `OnLevelUnloading` корректно удалять UI компоненты

**Файлы:** `src/LoadingExtension.cs`, `src/UI/IconButton.cs`

**Примечание:** Уже частично реализовано - кнопка создаётся при загрузке уровня.

#### 9.8 Добавление элементов управления в панель (заготовка)
**Цель:** Подготовить структуру для будущих элементов управления

**Детали:**
- [ ] Создать placeholder для dropdown режима (Hex/Districts)
- [ ] Создать placeholder для dropdown размера hex
- [ ] Создать placeholder для slider непрозрачности
- [ ] Создать placeholder для легенды
- [ ] Расположить элементы вертикально с отступами

**Файлы:** `src/UI/Panel/MainPanel.cs`

### Критерии завершения Task 9

- [x] Круглая кнопка видна на экране игры ✅
- [ ] Кнопку можно перетаскивать по экрану
- [ ] При клике на кнопку открывается панель
- [ ] При повторном клике панель закрывается
- [ ] Позиция кнопки сохраняется после перезагрузки игры
- [ ] UI элементы не конфликтуют с другими модами
- [ ] В логах нет ошибок при работе UI

### Приоритет подзадач

**Первая итерация (MVP UI):**
1. 9.1 - Создать базовую круглую кнопку ✅
2. 9.2 - Добавить перетаскивание
3. 9.3 - Добавить обработку клика
4. 9.4 - Создать базовую панель
5. 9.5 - Связать клик и показ панели
6. 9.7 - Интегрировать в LoadingExtension (частично выполнено)

**Вторая итерация (дополнительный функционал):**
7. 9.6 - Добавить сохранение позиции
8. 9.8 - Подготовить структуру для контролов
