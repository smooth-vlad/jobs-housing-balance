# Основные задачи инфраструктуры (Future Tasks)

## 1. Базовая структура и конфигурация мода
- Создать базовую структуру мода (metadata, AssemblyInfo, mod entry point)
- Настроить Harmony патчи для перехвата рендеринга (если необходимо)
- Определить конфигурационные параметры (размеры hex, цвета, частота обновления, размещение UI)
- Реализовать сохранение/загрузку настроек
- Инициализировать ColossalFramework.UI для создания нативных UI элементов

## 2. Утилиты для работы с гексами
- Реализовать систему координат для гексагональной сетки (аксиальные координаты q,r)
- Добавить функции конвертации координат: world → hex (pointy-top, мировые координаты)
- Реализовать алгоритм округления до ближайшего гекса (cube rounding) для преобразования world позиций в hex ячейки
- Добавить обратное преобразование hex → world для рендеринга

## 3. Модуль сбора данных
- Реализовать обход BuildingManager для получения всех зданий
- Подсчитывать количество жителей (CitizenUnits типа Home) на здание
- Подсчитывать количество рабочих мест (CitizenUnits типа Work) на здание
- Получать позицию здания и ID района
- Хранить собранные данные в удобной структуре

## 4. Агрегация по гексам
- Реализовать модуль AggregatorHex:
  - Распределять здания по hex ячейкам по их world позиции
  - Суммировать residents/jobs внутри каждой hex ячейки
  - Рассчитывать разницу `diff = jobs - residents` для каждой ячейки
  - Хранить результаты в словаре Map<(q,r), (residents, jobs, diff)>
  - Пересчитывать при обновлении данных

## 5. Агрегация по районам
- Реализовать модуль AggregatorDistricts:
  - Группировать здания по districtId
  - Суммировать residents/jobs внутри каждого района
  - Рассчитывать разницу `diff = jobs - residents` для каждого района
  - Хранить результаты в Map<districtId, (residents, jobs, diff)>

## 6. Нормализация и цветовое кодирование
- Рассчитывать максимальное абсолютное значение разности для текущего режима
- Вычислять коэффициент насыщенности t = |diff| / maxAbs
- Применять цветовое кодирование: положительные значения (синий), отрицательные (красный)
- Применять глобальную непрозрачность

## 7. Система рендеринга оверлея
- Реализовать OverlayRenderer:
  - Рендеринг hex ячеек (GL/OverlayEffect)
  - Рендеринг районов
  - Отрисовка с правильным цветом и прозрачностью
  - Отображение текстовых меток на каждом гексе/районе (показывает `jobs - residents`)
  - Обработка границ видимости камеры
  - Оптимизация отрисовки текста (могут показываться только для достаточно больших значений)

## 8. Главный контроллер/менеджер
- Создать контроллер для управления:
  - Переключение режимов (Hex/Districts)
  - Периодическое обновление данных (каждые 5-10 секунд игрового времени)
  - Управление кэшем
  - Триггеры обновления при изменении размера hex
  - Связь между UI, DataCollector, Aggregators и Renderer

## 9. UI элементы управления
- Создать dropdown для выбора режима (Hex/Districts)
- Создать dropdown для выбора размера hex (64/128/256/512; disabled при Districts)
- Создать slider для непрозрачности (0.1-0.8)
- Добавить легенду/подсказку с объяснением цветов
- Добавить кнопку включения/выключения слоя

## 10. Интеграция UI панели
- Создать и зарегистрировать UI панель в игре
- Расположить элементы управления из задачи 9
- Связать zoom состояние с рендерингом через контроллер
- Реализовать логику показа/скрытия панели
- Создать жизненный цикл (OnCreate, OnDestroy, OnUpdate)

## Дополнительные задачи

### 11. Оптимизация производительности
- Кэшировать список зданий между обновлениями
- Кэшировать агрегированные данные по hex при изменении размера
- Оптимизировать вызовы отрисовки GL
- Добавить culling для невидимых элементов

### 12. Тестирование и валидация
- Проверить работу на малых городах
- Сверить подсчеты с данными игры
- Провести тестирование производительности на больших городах
- Проверить совместимость с Realistic Population, TM:PE, RICO

### 13. Доводка и граничные случаи
- Обработать пустые ячейки (не рисовать)
- Обработать районы без ID (districtId = 0)
- Обработать пустые районы (без зданий)

## Что НЕ нужно для MVP

- Task 2: Утилиты для гексов
- Task 3: Сбор данных
- Task 4-5: Агрегация
- Task 6: Нормализация и цветовое кодирование
- Task 7: Система рендеринга оверлея
- Task 8: Главный контроллер/менеджер
- Task 9-10: UI элементы управления и панель
- Полноценный функционал визуализации

