# План реализации Этап B 2.0

## Обзор изменений

Этап B 2.0 добавляет новые режимы метрик и функциональность согласно документации "Этап B 2.0.md". Реализация будет поэтапной для удобства тестирования.

## Фазы реализации

### Фаза 1: Подготовка инфраструктуры
**Цель**: Расширить базовые структуры данных и AppState для поддержки новых режимов

#### 1.1 Расширение AppState
- Добавить enum `MetricType` (Fact, Capacity, EduAware)
- Добавить enum `EducationMode` (Strict, Substituted) 
- Добавить bool `IncludeServiceUnique` (по умолчанию true)
- Добавить bool `IncludeTeens` (по умолчанию false)
- Добавить события для новых свойств
- Обновить helper методы для работы с новыми enum'ами

#### 1.2 Расширение BuildingSample
- Добавить поля для Capacity режима:
  - `int jobsCapacityTotal`
  - `int[] jobsCapacityByEdu` (размер 4)
- Добавить поля для Education режима:
  - `int[] residentsByEdu` (размер 4)
- Добавить helper свойства:
  - `bool IsServiceBuilding`
  - `bool IsUniqueBuilding`
- Обновить конструктор и ToString()

#### 1.3 Обновление UI Layout
- Переделать MainPanel для размещения новых контролов
- Добавить Metric dropdown (Fact/Capacity/Edu-aware)
- Добавить IncludeServiceUnique checkbox
- Добавить EduMode dropdown (появляется только в Edu-aware режиме)
- Добавить IncludeTeens checkbox
- Обновить Legend для отображения разных режимов

### Фаза 2: Capacity режим
**Цель**: Реализовать сбор данных о потенциальной емкости рабочих мест

#### 2.1 JobsCapacityCollector
- Создать новый класс для сбора данных о емкости
- Реализовать извлечение данных из BuildingAI
- Поддержка детекции Realistic Population 2 мода
- Кэширование данных о емкости (редко меняется)
- Логирование для отладки

#### 2.2 Интеграция Capacity в BuildingDataCollector
- Добавить вызов JobsCapacityCollector
- Обновить CollectBuildingData для заполнения capacity полей
- Добавить фильтрацию сервисных/уникальных зданий
- Обновить валидацию зданий

#### 2.3 Тестирование Capacity режима
- Проверить корректность сбора данных о емкости
- Сравнить с Fact режимом в логах
- Проверить работу с RP2 модом (если установлен)

### Фаза 3: Education режим
**Цель**: Реализовать учет уровней образования жителей и требований к образованию рабочих мест

#### 3.1 EducationDataCollector
- Создать класс для сбора данных об образовании жителей
- Реализовать определение уровня образования гражданина
- Подсчет жителей по уровням образования (4 уровня)
- Учет работоспособного возраста (young adults + adults, опционально teens)

#### 3.2 Обновление BuildingDataCollector для Education
- Интегрировать EducationDataCollector
- Заполнять residentsByEdu поля в BuildingSample
- Добавить логирование для отладки education данных

#### 3.3 Логика сопоставления по образованию
- Реализовать Strict режим (сравнение 1:1 без перелива)
- Реализовать Substituted режим (перелив сверху вниз)
- Создать EducationMatcher класс для расчетов
- Добавить helper методы для расчета баланса по образованию

### Фаза 4: Интеграция и тестирование
**Цель**: Объединить все компоненты и провести комплексное тестирование

#### 4.1 Обновление OverlayRenderer
- Добавить поддержку новых режимов метрик
- Реализовать переключение между режимами
- Обновить расчет цветов для разных режимов
- Добавить отображение информации о RP2 в UI

#### 4.2 Обновление агрегации данных
- Модифицировать Hex и Districts агрегаторы
- Добавить поддержку новых метрик в расчетах
- Обновить логику определения цветов для разных режимов

#### 4.3 Комплексное тестирование
- Тестирование всех режимов по отдельности
- Тестирование переключения между режимами
- Проверка производительности с новыми данными
- Валидация корректности расчетов

## Детальный план по файлам

### Новые файлы
```
src/Data/Collector/
├── JobsCapacityCollector.cs      # Сбор данных о емкости рабочих мест
├── EducationDataCollector.cs     # Сбор данных об образовании
└── EducationMatcher.cs          # Логика сопоставления по образованию

src/Config/
└── AppState.cs                  # Расширенный (новые enum'ы и свойства)

src/UI/Panel/
└── MainPanel.cs                 # Обновленный layout с новыми контролами
```

### Изменяемые файлы
```
src/Data/Collector/
├── BuildingDataCollector.cs     # Интеграция новых коллекторов
├── BuildingSample.cs           # Новые поля для capacity и education
└── DataCache.cs               # Обновление кэширования

src/Rendering/Overlay/
└── OverlayRenderer.cs          # Поддержка новых режимов

src/Aggregation/
├── Hex/HexAggregator.cs       # Поддержка новых метрик
└── Districts/DistrictsAggregator.cs # Поддержка новых метрик
```

## Порядок реализации

1. **Фаза 1** - Подготовка инфраструктуры (AppState, BuildingSample, UI)
2. **Фаза 2** - Capacity режим (JobsCapacityCollector + интеграция)
3. **Фаза 3** - Education режим (EducationDataCollector + логика сопоставления)
4. **Фаза 4** - Интеграция и тестирование

## Критерии готовности каждой фазы

- **Фаза 1**: UI отображает новые контролы, AppState содержит новые свойства
- **Фаза 2**: Capacity режим работает и показывает корректные данные в логах
- **Фаза 3**: Education режим работает с обоими режимами сопоставления
- **Фаза 4**: Все режимы работают корректно, производительность приемлемая

## Особенности реализации

### Производительность
- Capacity данные кэшируются (редко меняются)
- Education данные пересчитываются по необходимости
- Интервальное обновление каждые 5-10 секунд сохраняется

### Совместимость
- Поддержка More CitizenUnits (динамические размеры массивов)
- Детекция Realistic Population 2 мода
- Graceful degradation при отсутствии модов

### Логирование
- Детальные логи для каждого режима
- Отдельные логи для capacity и education данных
- Информация о детекции модов

## Тестирование

Каждая фаза тестируется отдельно:
1. Проверка корректности сбора данных через логи
2. Проверка переключения режимов
3. Проверка производительности
4. Валидация расчетов в разных сценариях

После каждой фазы - компиляция и тестирование в игре.
