Отличные вопросы — это как раз те “острые углы”, о которые чаще всего спотыкаются при первой реализации J–H баланса в CS1. Ниже — ответы и конкретика, чтобы второй ИИ сделал всё правильно, без кода, но с указанием, где и что брать.

---

# 1) Где хранится образование у гражданина?

- **Это не флаг в `Citizen.Flags`.** Уровень образования хранится отдельным полем/свойством в самом `Citizen` и используется как **целочисленный уровень 0..3** (Uneducated / Educated / Well educated / Highly educated). Это же четырёхуровневое разделение используется всеми AI-классами зданий при расчёте потребности в работниках по образованию. Подтверждение четырёх уровней в механике игры — в официальной вики по гражданам. ([skylines.paradoxwikis.com](https://skylines.paradoxwikis.com/Citizens?utm_source=chatgpt.com "Citizens - Cities: Skylines Wiki"))
    
- **Как читать корректно.** В ванильном API уровень образования гражданина доступен через соответствующий геттер (в деассемблированном `Assembly-CSharp` вы увидите вызов наподобие `GetEducationLevel(...)` у `Citizen`). Точное имя члена может отличаться от релиза к релизу и не задокументировано, поэтому **правильный путь — открыть игру ILSpy/dnSpy и посмотреть у себя текущие сигнатуры**. Гайд по реверсу с ILSpy для CS1: шаги и место, где искать — в моддинговой доке. ([citiesskylinesmoddingguide.readthedocs.io](https://citiesskylinesmoddingguide.readthedocs.io/en/latest/modding/Workflow/Reverse-Engineering.html?utm_source=chatgpt.com "Reverse Engineering - Cities:Skylines Modding's documentation"))
    

> Практический вывод для ТЗ:  
> **Нельзя** подменять образование “вероятностями по возрасту”. Нужно читать реальное значение из `Citizen` через геттер/поле. Счёт ведём в массив `int[4]` — по уровням 0..3.

---

# 2) Сервисные здания: откуда взять _вместимость рабочих мест_ (capacity), а не фактическую занятость

В CS1 источники “capacity by edu level” зависят от типа AI:

1. **Зонируемые здания** (`IndustrialBuildingAI`, `CommercialBuildingAI`, `OfficeBuildingAI`, `OfficeHighTechBuildingAI`) — имеют **метод**  
    `CalculateWorkplaceCount(itemClass, width, length, out level0, out level1, out level2, out level3)`  
    Это канонический способ получить _номинальные_ (дизайнерские) квоты по образованию. Посмотреть сигнатуры и поведение проще всего в документации/вики Realistic Population Revisited — мод именно этот метод перехватывает и замещает расчёты. ([GitHub](https://github.com/algernon-A/Realistic-Population-Revisited "GitHub - algernon-A/Realistic-Population-Revisited"))
    
2. **Сервисные/городские здания** (`HospitalAI`, `PoliceStationAI`, `FireStationAI`, `SchoolAI`, `UniversityAI`, `ParkAI` и т.п.) — часто **не реализуют** свой `CalculateWorkplaceCount`, а держат **сериализованные поля** с разбивкой рабочих мест по уровням (типичный паттерн: `m_workPlaceCount0`, `m_workPlaceCount1`, `m_workPlaceCount2`, `m_workPlaceCount3`).  
    Отсюда рекомендуемая стратегия:
    
    - Сначала попытаться вызвать `CalculateWorkplaceCount` у `m_info.m_buildingAI` (безопасно для зонируемых и части ploppable RICO).
        
    - Если метода нет/он возвращает нули — **reflection** по полям AI и чтение `m_workPlaceCount*`.
        
    - Если и полей нет (редкие исключения или кастомные ассеты), использовать простую эвристику по префабу (площадь футапринта/уровень/класс) до тех пор, пока не найдете реальные поля в конкретном AI через ModTools/Scene Explorer.  
        На практике именно так делает большинство “реалистичных популяционных” модов; см. как Realistic Population системно перераспределяет квоты по уровням образования — это подтвердит, что распределения по edu существуют в виде 4 значений на здание. ([GitHub](https://github.com/algernon-A/Realistic-Population-Revisited "GitHub - algernon-A/Realistic-Population-Revisited"))
        

> Практический вывод для ТЗ:  
> В блок “B.1/B.2” добавьте два пути получения capacity:  
> (а) сначала `CalculateWorkplaceCount(...)` → берём `level0..level3`;  
> (б) fallback: reflection `m_workPlaceCount0..3` у AI сервисных зданий;  
> (в) супер-fallback: эвристика по префабу, пока не найдёте реальные поля через деассемблирование/ModTools. (Для поддержки будущих патчей укажите в документе, что имена полей могут отличаться; обязателен фича-флаг и подробный лог.)

---

# 3) “Фактическая занятость по образованию” (OccupancyByEdu) — откуда брать

Есть два валидных источника факта:

**Вариант А (рекомендуемый для корректной привязки к зданию):**  
Обход **`CitizenUnit`** у конкретного здания → берём **юниты с флагом Work** → проходим граждан в юните → считаем их образование. Это даёт точную “занятость рабочих мест по edu” именно в этом здании (даже если у гражданина ещё есть временныe состояния). Подтверждение роли CitizenUnit в экономике (в т.ч. привязка юнита к рабочим слотам) есть в профильных обсуждениях и гайдах моддеров; CitizenUnit — это базовая кирпичика “N граждан/посетителей/студентов/пациентов/рабочих” для здания/транспорта и пр. (например, 1 юнит ≈ 5 рабочих мест и т.п.). ([steamcommunity.com](https://steamcommunity.com/app/255710/discussions/0/596279596963412213/?utm_source=chatgpt.com "What factors can cause the continuous increase of \"citizen ..."))

**Вариант B (кросс-проверка и диагностика):**  
Обход всех граждан и фильтрация по **их полю “рабочее здание”** (т.е. _work building id_ гражданина). Этот “reverse-link” тоже есть у `Citizen` (ссылка на ID здания работы), но имя члена не документировано — проверьте в вашем билде через ILSpy/ModTools. Гайды по реверсу — см. выше. ([citiesskylinesmoddingguide.readthedocs.io](https://citiesskylinesmoddingguide.readthedocs.io/en/latest/modding/Workflow/Reverse-Engineering.html?utm_source=chatgpt.com "Reverse Engineering - Cities:Skylines Modding's documentation"))

Дополнительно, чтобы не путать “факт” и “дизайн-вместимость”:

- **Факт** — это сколько реально назначено работников (через юниты Work). Это же показывает, например, мод Building Usage (“число работников, назначенных зданию”, вне зависимости от того, находятся ли они физически в нём прямо сейчас). ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2048266761&utm_source=chatgpt.com "Building Usage - Workshop"))
    
- **Capacity** — это квоты `level0..3` из AI/префаба (см. пункт 2). Их никогда не путайте: для поиска дисбалансов нужны оба режима.
    

> Практический вывод для ТЗ:  
> В “B.1” добавьте сбор **двух наборов** данных по каждому зданию:
> 
> - `JobsCapacityByEdu[4]` — из AI (`CalculateWorkplaceCount` или `m_workPlaceCount*`).
>     
> - `JobsOccupancyByEdu[4]` — через обход `CitizenUnit` с флагом Work (или через обратную ссылку гражданина на здание работы).  
>     В “B.5” — сверка: сумма `JobsOccupancyByEdu` ≤ суммы capacity, логирование расхождений.
>     

---

## Ответы на ваши уточнения

**Q1. “Служебные здания участвуют?”**  
Да. Городские сервисы (больницы, полиции, пожарные, школы, парки и т.д.) тоже имеют **штат работников с распределением по образованию** — их нужно учитывать в балансе рабочих мест по секторам/гексам/районам наряду с коммерцией/промом/офисами. Баланс J–H — это _все_ рабочие места, не только зонируемые. (По квотам см. выше; подробнее о сервисных зданиях в вики — списки и назначение, полезно при отладке эвристик). ([skylines.paradoxwikis.com](https://skylines.paradoxwikis.com/Service_buildings?utm_source=chatgpt.com "Service buildings - Cities: Skylines Wiki"))

**Q2. “Сейчас считаю ‘сколько людей работает’. Но нужен и ‘сколько МОЖЕТ работать’.”**  
Именно поэтому держим **два режима**: _Capacity_ (квоты из AI) и _Occupancy_ (факт из `CitizenUnit`). Это позволит подсветить «в гексе хватает фактических работников, но capacity у сервисов огромная → перекос» или наоборот — «capacity есть, а люди не подходят по образованию».

**Q3. “Как учесть образование (например, много мест для необразованных, а в городе — в основном образованные)?”**  
Считаем **баланс отдельно по каждому уровню** и агрегируем:  
`EduGap[level] = Capacity[level] - EligibleResidents[level]`  
где `EligibleResidents[level]` — количество трудоспособных жителей этого уровня, проживающих в этом гексе/районе (или “в зоне доступности”, если добавите транспортный радиус позже). Коротко о том, что уровни — именно четыре и что они важны для занятости/прокачки зданий — см. вики. ([skylines.paradoxwikis.com](https://skylines.paradoxwikis.com/Citizens?utm_source=chatgpt.com "Citizens - Cities: Skylines Wiki"))

---

## Что именно обновить в вашем “Этапе B” (для раздела «Изменения в ТЗ»)

**B.1 — Сбор факта**

- **Добавить:** сбор **JobsOccupancyByEdu[4]** через обход **`CitizenUnit` с типом Work** у каждого здания.
    
- **Добавить:** сбор **JobsCapacityByEdu[4]**:
    
    1. попытка `CalculateWorkplaceCount(..., out l0..l3)`;
        
    2. если нет — reflection `m_workPlaceCount0..3` у AI сервисных зданий;
        
    3. при отсутствии полей — временная эвристика по префабу + лог.  
        (Сигнатуры `CalculateWorkplaceCount` и распределения по edu см. у Realistic Population Revisited.) ([GitHub](https://github.com/algernon-A/Realistic-Population-Revisited "GitHub - algernon-A/Realistic-Population-Revisited"))
        
- **Уточнить:** Residents (факт) — по `CitizenUnit` с флагом Home; Jobs (факт) — по `CitizenUnit` с флагом Work. Подтверждение роли CitizenUnit в ограничениях/назначениях — см. обсуждения лимитов (1 юнит ≈ пакеты по 5 слотов и т.п.). ([steamcommunity.com](https://steamcommunity.com/app/255710/discussions/0/596279596963412213/?utm_source=chatgpt.com "What factors can cause the continuous increase of \"citizen ..."))
    
- **Уточнить:** образование **читать из реального поля/геттера** у `Citizen` (а не по возрастным вероятностям). Для проверки точных имён членов использовать ILSpy/ModTools. ([citiesskylinesmoddingguide.readthedocs.io](https://citiesskylinesmoddingguide.readthedocs.io/en/latest/modding/Workflow/Reverse-Engineering.html?utm_source=chatgpt.com "Reverse Engineering - Cities:Skylines Modding's documentation"))
    

**B.2 — Кэш**

- **Расширить структуру:** хранить и `JobsCapacityByEdu[4]`, и `JobsOccupancyByEdu[4]`; отдельные `isDirty`на “capacity” (грязнеет при смене префаба/политик/модов, как Realistic Population) и на “occupancy” (грязнеет по интервалу/событиям).
    
- **Логирование:** писать версию игры/хэш сборки AI в кэш, чтобы инвалидация происходила после обновлений.
    

**B.3 — Триггеры**

- **События:** постройка/снос, апгрейд уровня здания, смена стиля/префаба RICO, включение/выключение здания, а также **изменение настроек Realistic Population** (т.к. мод может менять квоты `CalculateWorkplaceCount`). Периодический пересчёт occupancy — каждые N игровых секунд, capacity — реже. Подтверждение того, что RP2 “перехватывает” рабочие квоты — см. их список Harmony-патчей. ([GitHub](https://github.com/algernon-A/Realistic-Population-Revisited "GitHub - algernon-A/Realistic-Population-Revisited"))
    

**B.4 — Интеграция**

- **Два слоя визуализации:**
    
    - Режим **Capacity gap** (по edu и в целом) — где “можно принять” работников;
        
    - Режим **Occupancy gap** — где фактически не хватает/избыток рабочих.
        
- **Переключатели:** “по гексам / по районам”, “размер гекса”, “capacity vs occupancy”, “по каждому edu 0..3 / суммарно”.
    

**B.5 — Валидация**

- **С RP/Realistic Population:** сравнить capacity до/после включения мода, убедиться, что модифицированные квоты попадают к вам через `CalculateWorkplaceCount`. ([GitHub](https://github.com/algernon-A/Realistic-Population-Revisited "GitHub - algernon-A/Realistic-Population-Revisited"))
    
- **С Building Usage:** сверить ваш “факт работников” с показателями мода (“назначено работников”) на одном и том же здании. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2048266761&utm_source=chatgpt.com "Building Usage - Workshop"))
    
- **Нагрузочные тесты:** проверить на большом городе — учитывайте лимиты CitizenUnit и их связь с рабочими слотами. ([steamcommunity.com](https://steamcommunity.com/app/255710/discussions/0/596279596963412213/?utm_source=chatgpt.com "What factors can cause the continuous increase of \"citizen ..."))
    

---

## Короткий FAQ

- **Нужно ли считать гос/сервисные здания?** Да, это такие же работодатели, с разбивкой по edu. ([skylines.paradoxwikis.com](https://skylines.paradoxwikis.com/Service_buildings?utm_source=chatgpt.com "Service buildings - Cities: Skylines Wiki"))
    
- **Можно ли обойтись без reflection?** Для зонируемых — зачастую да (через `CalculateWorkplaceCount`). Для сервисов — чаще всего без reflection не обойтись (или используйте временную эвристику, пока не найдёте поля). ([GitHub](https://github.com/algernon-A/Realistic-Population-Revisited "GitHub - algernon-A/Realistic-Population-Revisited"))
    
- **Где подтвердить имена полей/методов в моей версии?** Деассемблируйте `Assembly-CSharp.dll`ILSpy/ModTools — это нормальная практика в CS1-моддинге. ([citiesskylinesmoddingguide.readthedocs.io](https://citiesskylinesmoddingguide.readthedocs.io/en/latest/modding/Workflow/Reverse-Engineering.html?utm_source=chatgpt.com "Reverse Engineering - Cities:Skylines Modding's documentation"))
    

Если хочешь, добавлю в документ готовые “чек-листы” по инспекции конкретных AI (HospitalAI/PoliceStationAI/SchoolAI), чтобы второй ИИ сразу знал, какие поля искать и какие логи выводить при fallback’ах.