## thinking
Чтение документов

Чтение документов

Проводим исследования для изменений в ТЗ

Поиск информации о лимитах граждан и руководствах

Предлагаем изменения в ТЗ и Этапе B

Нам нужно предложить новые метрики, например, добавить "Службы/Уникальные здания" с переключателем и исключить "Внешние соединения". Рассмотрим добавление режима емкости для JobsCapacity, основываясь на BuildingAI или моде Realistic Population 2. Нужно учесть разницу в образовании и алгоритм для распределения потребности и предложения по уровням образования.

Поиск информации о работниках с образованием для Cities: Skylines

Предлагаем добавить службы в рабочие места

Нужно предложить включить служебные здания в метрики рабочих мест. Можно сослаться на то, что эти здания нанимают сотрудников, даже если на странице вики не указано количество работников. Разделы о счастье или политике упоминают образование для офисов, но лучше сослаться на информацию в панели зданий, где показывается разбивка по сотрудникам.

Поиск информации о панелях зданий и работниках

Предложения по обновлению документа

У нас достаточно источников, чтобы обновить документацию с цитированиями. Нужно также учесть образовательную заменяемость и соответствие. Для Б-этапа предлагаем новые метрики: вместо простого подсчета фактов — добавить емкости и учитывать образование. Для новых определений: JobsCapacity, распределение по уровням образования, сотрудники по данным Building AI и модам.

Учет подмены по образованию

В описании мода "Building Usage" упоминается определение подходящих работников, что поможет с учетным нюансом по возрасту рабочей силы. Также по поводу подмены по образованию — более образованные сотрудники могут заполнять вакансии низшего уровня. Мы нашли подтверждение на странице вики "Obrazovanie", и нужно проверить точность цитаты.

Цитирование и подтверждающие материалы

Нужно указать ссылки на вики "Service buildings" и "Happiness", а также на функционал CS2, чтобы обосновать наличие рабочих мест в служебных зданиях, избегая опираться на CS2. Упоминаем мод "Building Usage" для подтверждения, что в служебных зданиях есть рабочие места.

Также исключаем внешние соединения, ссылаясь на моды и форумы.

Поиск модификаций для обновления документации и изменений

Подтверждающие источники

У нас есть все необходимые источники: данные из Simtropolis, а также уточнения по CitizenUnit из руководства Steam. Мод Realistic Population 2 – для изменений в количестве рабочих мест и домохозяйств. Вики по образованию включает правило подмены, а мод "Building Usage" подтверждает наличие рабочих мест в служебных зданиях.

Изменения в ТЗ

Нужно добавить переключатель "Включить служебные/уникальные" по умолчанию. Используем два режима данных: Факты и Ёмкость, с учётом образования. Нужно обновить UI с тубиклами для режимов и метрик. Для Stage B добавить обновления, включая новые типы зданий и обработки ёмкости, а также кэширование и поддержку событий.
## general info
отлично, давай оформим это как «Изменения в ТЗ» + обновлённый «Этап B» (с учётом твоих новых требований: capacity, сервисные здания, образование). Ниже — текст, который можно прямо вставить в док.

---

# Изменения в ТЗ

**Что добавилось по смыслу:**

1. **Два источника метрик**
    
    - **Fact (по факту):** считаем реально живущих и реально работающих через `CitizenUnit` (Home/Work). Это устойчиво к Realistic Population 2, т.к. отражает текущее заселение/занятость. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2712549268&utm_source=chatgpt.com "Guide :: Cities Skylines Game Limits"))
        
    - **Capacity (ёмкость):** считаем «сколько может работать» по данным `BuildingAI`/инфопанели (разбивка рабочих мест и их требования к образованию); RP2 изменяет эти числа — в моде явно помечаем, что capacity учитывает RP2, если он активен. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2025147082&utm_source=chatgpt.com "Steam Workshop::Realistic Population 2 2.2.4"))
        
2. **Education-aware режим (соответствие уровням образования)**  
    Вводим расчёт спроса/предложения по 4 уровням образования (uneducated/educated/well/highly-educated), т.к. здания требуют «достаточно образованных» работников, а более образованные могут занимать низкоуровневые позиции при нехватке. В UI — два варианта метрики:
    
    - **Strict gap:** без «перелива» уровней;
        
    - **Substituted gap:** разрешён перелив сверху вниз (well/highly могут закрывать educated/uneducated). ([Skylines Wiki](https://skylines.paradoxwikis.com/Education?utm_source=chatgpt.com "Education - Cities: Skylines Wiki"))
        
3. **Учитываем сервисные/уникальные здания**  
    По умолчанию включаем их в суммарные рабочие места, с тумблером **Include service/unique** (ON). Практические инструменты для игрока и моды показывают занятость и по «service»-типам, так что их вклад реален. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2048266761&utm_source=chatgpt.com "Building Usage - Workshop"))
    
4. **Исключаем Outside Connections**  
    В баланс района они не должны попадать (это «порты/ворота», а не локальные рабочие места). Явно фильтруем эти типы. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2367735356&utm_source=chatgpt.com "Unlimited Outside Connections Revisited 1.1"))
    
5. **Работоспособный возраст (опция)**  
    В supply по людям по умолчанию считаем **young adults + adults** (опционально включать teens при Hadron Collider). Это ближе к реальному «кто может работать» и отражено в аналитических модах. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2048266761&utm_source=chatgpt.com "Building Usage - Workshop"))
    
6. **Гекс-сетка с пресетами 64/128/256/512 и Districts**  
    Оставляем оба режима; конверсия world→hex по классике Red Blob (axial/cube + cube rounding), чтобы не было артефактов. ([redblobgames.com](https://www.redblobgames.com/grids/hexagons/?utm_source=chatgpt.com "Hexagonal Grids"))
    
7. **Производительность и совместимость**  
    — Пересчёт не чаще 1 раза в 5–10 игровых секунд и/или по событиям (BuildingExtensionBase хуки), тяжёлое — на симуляционном потоке.  
    — Не хардкодим размеры массивов (совместимость с More CitizenUnits). ([Simtropolis](https://community.simtropolis.com/forums/topic/73502-modding-tutorial-4-make-historical/?utm_source=chatgpt.com "Modding Tutorial 4: Make Historical"))
    

---

# Этап B — Сбор данных (обновлённая версия)

## B.1 Факты по каждому зданию (ResidentsFact / JobsFact)

**Цель:** собрать **по факту** количество жителей и занятых работников.

**Правила извлечения:**

- Идём по `BuildingManager.m_buildings.m_buffer`, берём только валидные/созданные инстансы. Для ID района используем `DistrictManager` по мировой позиции здания. События создания/сноса — через хуки `BuildingExtensionBase` (для инвалидации). ([Simtropolis](https://community.simtropolis.com/forums/topic/73502-modding-tutorial-4-make-historical/?utm_source=chatgpt.com "Modding Tutorial 4: Make Historical"))
    
- Обходим связанный список `CitizenUnit` у здания; суммируем **занятые слоты** (`m_citizen0..m_citizen4`ненулевые):
    
    - **Home → ResidentsFact**,
        
    - **Work → JobsFact** (для нежилых). Игнорируем Visit/Student/Customer/Patient. Обязательное замечание: один `CitizenUnit` — контейнер до 5 граждан; счёт «по факту» = по реально занятым слотам. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2712549268&utm_source=chatgpt.com "Guide :: Cities Skylines Game Limits"))
        
- **Service/Unique включены** по умолчанию (тумблер в UI), **Outside Connections** — исключаем из расчёта. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2048266761&utm_source=chatgpt.com "Building Usage - Workshop"))
    

**Почему это корректно:** юнит-модель игры даёт 1 `CitizenUnit` на домохозяйство и по одному на каждые ~5 рабочих мест/клиентов/посетителей — т.е. мы читаем реальную занятость/заселение, что устойчиво к RP2. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2712549268&utm_source=chatgpt.com "Guide :: Cities Skylines Game Limits"))

---

## B.1′ (новое) Ёмкости по рабочим местам (JobsCapacity)

**Цель:** собрать «сколько **может** работать» (и требуемые уровни образования) для режима Capacity и Education-aware.

**Правила:**

- Источник — **параметры здания** (`BuildingAI`) / инфопанель (в т.ч. разбивка по уровням образования, видимая игроку; валидировано модами аналитики, которые показывают workplaces по уровням и типам). Храним: `jobsCapacityTotal` и `jobsCapacityByEdu[4]`. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2048266761&utm_source=chatgpt.com "Building Usage - Workshop"))
    
- Если активен **Realistic Population 2**, capacity отражает изменённые правила (RP2 перерасчитывает домохозяйства и рабочие места реалистичнее). В UI пометка: _Capacity base: Vanilla | RP2 (detected)_. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2025147082&utm_source=chatgpt.com "Steam Workshop::Realistic Population 2 2.2.4"))
    

---

## B.1″ (новое) Предложение по образованию (ResidentsByEdu)

**Цель:** подготовить supply по образованию для сравнения с `jobsCapacityByEdu`.

**Правила:**

- Для каждого `Home`-юнита жителей определяем их уровень образования (4 уровня: uneducated / educated / well-educated / highly-educated). Суммируем в `residentsByEdu[4]`. ([Skylines Wiki](https://skylines.paradoxwikis.com/Education?utm_source=chatgpt.com "Education - Cities: Skylines Wiki"))
    
- По умолчанию **учитываем workforce-возраст** (young adults + adults); настройка «Include teens (Hadron Collider)» — опционально. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2048266761&utm_source=chatgpt.com "Building Usage - Workshop"))
    

---

## B.2 Кэширование

**Что кэшируем:**

- На здание: `{position, districtId, residentsFact, jobsFact, residentsByEdu[4]?}` + `lastUpdatedFrame`, `isDirty`.
    
- Отдельно (редко меняется): `{jobsCapacityTotal, jobsCapacityByEdu[4]}`.
    

**Инвалидация и обновление:**

- Интервальный пересчёт **раз в 5–10 игровых секунд** (привязка к кадрам симуляции).
    
- Немедленно по событиям (create/relocate/release).
    
- Делим полный проход по зданиям на чанки (инкрементальные апдейты). ([Skylines Wiki](https://skylines.paradoxwikis.com/Modding_Basics?utm_source=chatgpt.com "Modding Basics - Cities: Skylines Wiki"))
    

---

## B.3 Триггеры пересчёта

- **Критичные:** создание/снос/перенос здания — инвалидация точек/гексов поблизости. ([Simtropolis](https://community.simtropolis.com/forums/topic/73502-modding-tutorial-4-make-historical/?utm_source=chatgpt.com "Modding Tutorial 4: Make Historical"))
    
- **Параметрические:** смена режима (Hex/Districts), размера гекса, включение/выключение Service/Unique, переключение Fact/Capacity/Edu-aware — пересчитываем только то, что нужно (агрегаторы/цвета), без лишнего обхода юнитов.
    
- **Системные:** детект RP2 — при смене «базы» capacity пометить capacity-кэш «грязным». ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2025147082&utm_source=chatgpt.com "Steam Workshop::Realistic Population 2 2.2.4"))
    

---

## B.4 Подготовка к агрегации (перед этапом C)

- **Hex:** для каждого сэмпла вычисляем hex-ID (axial/cube + cube-rounding) по выбранному размеру 64/128/256/512. ([redblobgames.com](https://www.redblobgames.com/grids/hexagons/?utm_source=chatgpt.com "Hexagonal Grids"))
    
- **Districts:** группируем по `districtId`.
    
- Готовим три набора агрегатов для рендера:
    
    1. **Balance (Fact):** `jobsFact − residentsFact`;
        
    2. **Balance (Capacity):** `jobsCapacityTotal − residentsTotal` (если включён режим Capacity);
        
    3. **Edu-aware:** по уровням: `gap_e = jobsCapacity_e − residentsByEdu_e`; сводный цвет — сумма дефицитов с учётом выбранного режима **Strict/Substituted** (см. ниже). ([Skylines Wiki](https://skylines.paradoxwikis.com/Education?utm_source=chatgpt.com "Education - Cities: Skylines Wiki"))
        

---

## B.5 Правила сопоставления по образованию (для Edu-aware)

- **Strict:** сравниваем по уровням 1:1 без перелива.
    
- **Substituted:** разрешаем **перелив сверху вниз** — более образованные могут закрывать более низкие позиции (механика игры это допускает). Рекомендуем жадный алгоритм «high→well→educated→uneducated», коэффициент по умолчанию 1:1. ([Skylines Wiki](https://skylines.paradoxwikis.com/Education?utm_source=chatgpt.com "Education - Cities: Skylines Wiki"))
    

---

## B.6 Валидация

- Выборочная проверка: сумма `residentsFact` по гексам ≈ населению (допустима разница из-за туристов/посетителей).
    
- Тест: после массового прироста офисов **Capacity→синий** (нужно жильё), после прироста жилого **Capacity→красный** (нужны jobs).
    
- Проверка Edu-aware: при дефиците «well/highly» и профиците «educated/uneducated» **Strict** покажет явный «красный», **Substituted** частично смягчит.
    
- Производительность: на больших городах — чанк-скан + интервал, без падения FPS.
    
- Совместимость: при активном **More CitizenUnits** не используем жёстких констант — читаем размеры массивов в рантайме. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2654364627&utm_source=chatgpt.com "Steam Workshop::More CitizenUnits 1.1.3"))
    

---

## Обновления UI (минимум для этого этапа)

- **Metric:** `Fact | Capacity | Edu-aware` (в Edu-aware выпадающий режим `Strict | Substituted`).
    
- **Include service/unique:** `On/Off` (ON по умолчанию). ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2048266761&utm_source=chatgpt.com "Building Usage - Workshop"))
    
- **Mode:** `Hex | Districts`; **Hex size:** `64/128/256/512`.
    
- В легенде отдельно пояснить: «красный — нужны рабочие места», «синий — нужно жильё»; для Edu-aware — подсказка с разбивкой по уровням.
    

---

### Почему эти изменения важны (кратко с источниками)

- **CitizenUnit «по факту»** — надёжный способ считать реальную занятость/заселение; 1 юнит на домохозяйство и ~1 на 5 рабочих мест/клиентов/посетителей — подтверждённые лимит-гайдом/дискуссиями. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2712549268&utm_source=chatgpt.com "Guide :: Cities Skylines Game Limits"))
    
- **RP2 меняет ёмкости (capacity)** — дома/офисы/магазины получают более реалистичные семейства и рабочие места; поэтому нужен второй режим. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2025147082&utm_source=chatgpt.com "Steam Workshop::Realistic Population 2 2.2.4"))
    
- **Образование критично для трудоустройства** — здания «просят» более образованных по мере роста; граждане могут брать работу **ниже** своего уровня при нехватке. ([Skylines Wiki](https://skylines.paradoxwikis.com/Education?utm_source=chatgpt.com "Education - Cities: Skylines Wiki"))
    
- **Service/Unique тоже создают рабочие места** — аналитические инструменты и инфопанели учитывают их как «workplaces», поэтому в общегородском балансе их вклад нужен; оставляем тумблер для гибкости. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2048266761&utm_source=chatgpt.com "Building Usage - Workshop"))
    
- **Hex-математика** — стандартная реализация через axial/cube конверсии и cube-rounding исключает «дребезг» на границах. ([redblobgames.com](https://www.redblobgames.com/grids/hexagons/?utm_source=chatgpt.com "Hexagonal Grids"))
    
- **События/потоки** — хуки жизненного цикла зданий (BuildingExtensionBase) + периодическое обновление на симуляционном потоке — best practice для CS1. ([Simtropolis](https://community.simtropolis.com/forums/topic/73502-modding-tutorial-4-make-historical/?utm_source=chatgpt.com "Modding Tutorial 4: Make Historical"))
    
- **Совместимость с лимит-модами** — нельзя полагаться на фикс-лимиты; More CitizenUnits прямо предупреждает. ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2654364627&utm_source=chatgpt.com "Steam Workshop::More CitizenUnits 1.1.3"))
    

---

если хочешь, могу следом оформить короткий **чек-лист UX/легенды** и **минимальные тест-кейсы** для нового Edu-aware/Capacity (в том же стиле — пункты для второго ИИ, без кода).