
Отличные вопросы — это как раз те места, где «быстрый прототип» упирается в реальные механики CS1. Ниже — что именно меняем в ТЗ и как корректно добывать данные из игры, чтобы второй ИИ не гадал.

# Что меняется в ТЗ («Изменения в ТЗ»)

1. **Два режима рабочих мест:**
    
    - **Вместимость (capacity)** — «сколько _может_ работать» в здании, по градациям образования.
        
    - **Факт (occupancy)** — «сколько _сейчас_ работает».  
        Оба нужны: capacity — для планирования застройки; occupancy — чтобы видеть текущие провалы по найму.
        
2. **Источник «capacity» по типам зданий:**
    
    - **Зонированные (Commercial/Industrial/Extractor/Office):** брать через `*BuildingAI.CalculateWorkplaceCount(level, Randomizer, width, length, out level0..level3)` — это стандартный ванильный расчёт рабочих мест и распределение по образованию (0–3), который патчится Realistic Population и RICO (так что вы автоматически получите их правки) ([GitHub](https://github.com/algernon-A/Realistic-Population-Revisited/wiki/Harmony-patches "Harmony patches · algernon-A/Realistic-Population-Revisited Wiki · GitHub")).
        
    - **Сервисные/уникальные/монументы:** у них тоже есть «разрешённые работники». Универсального одного API-метода нет, но значения хранятся в AI-классах префабов (и редактируются модами наподобие **Customize It (Extended)** — это подтверждает, что capacity у сервисов существует и доступно) ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=1806759255&utm_source=chatgpt.com "Customize It Extended - Workshop")). В вашем моде: считывать через отражение (reflection) поля типа `m_workPlaceCount*`/аналогичные **или** вызывать их специализированные методы, если присутствуют (подробности ниже).
        
    - NB: Сервисные здания **могут работать и при нуле работников** (игра не жалуется), но capacity там всё равно есть и «съедает» трудовые ресурсы — поэтому учитывать их имеет смысл для баланса «jobs↔housing» ([skylines.paradoxwikis.com](https://skylines.paradoxwikis.com/Service_buildings?utm_source=chatgpt.com "Service buildings - Cities: Skylines Wiki")).
        
3. **Образование — только реальные флаги, никакой «рандомизации»:**  
    В игре 4 уровня: **Uneducated / Educated / Well-educated / Highly-educated** (0..3). Эти уровни применяются и к вакансиям, и к гражданам; их и надо сводить при расчётах баланса по образованию ([skylines.paradoxwikis.com](https://skylines.paradoxwikis.com/Education?utm_source=chatgpt.com "Education - Cities: Skylines Wiki")). Поле уровня образования хранится у **Citizen** (см. практику моддеров: реальный путь — деобфускация/ILSpy и обращение к полю уровня образования вместо «угадываний по возрасту») ([citiesskylinesmoddingguide.readthedocs.io](https://citiesskylinesmoddingguide.readthedocs.io/en/latest/modding/Workflow/Reverse-Engineering.html?utm_source=chatgpt.com "Reverse Engineering - Cities:Skylines Modding's documentation")).
    
4. **Новый показатель: «Jobs – EligibleResidentsByEdu»**  
    Для каждого тайла/района считаем в разрезе 4 уровней образования:
    
    - **JobsCapacityByEdu[k]** из AI зданий (см. п.2);
        
    - **EligibleResidentsByEdu[k]** — реальный срез жителей по Home-юнитам и их образованию (см. п. «Как получить образование гражданина»);
        
    - Итоги: `GapByEdu[k] = JobsCapacityByEdu[k] – EligibleResidentsByEdu[k]`, плюс агрегаты `Sum(GapByEdu)` и классический `Jobs – Residents`.
        
5. **Совместимость с Realistic Population / RICO:**  
    Не «подменять» формулы — **наоборот**, вызывать их расчёты (патчи Harmony этих модов перехватывают `CalculateWorkplaceCount`, так что вы получите «правильные» цифры без двойной логики) ([GitHub](https://github.com/algernon-A/Realistic-Population-Revisited/wiki/Harmony-patches "Harmony patches · algernon-A/Realistic-Population-Revisited Wiki · GitHub")).
    

---

# Как поправить ваш «Этап B — Сбор данных» (детально и без кода)

## B.1 Итерация по зданиям и сбор фактов (обновлённая версия)

**Цель:** собирать _две_ метрики: вместимость рабочих мест (capacity, с разбивкой по образованию) и фактическую занятость (occupancy).

1. **Обход зданий** через `BuildingManager.m_buildings.m_buffer`. Пропускать: неинициализированные, без `Info`, без юнитов — как и планировалось.
    
2. **Определение типа AI и извлечение capacity:**
    
    - Если `building.Info.m_buildingAI` — один из: `CommercialBuildingAI`, `IndustrialBuildingAI`, `IndustrialExtractorAI`, `OfficeBuildingAI`,  
        то вызвать **ванильный метод**:  
        `CalculateWorkplaceCount(level, rand, width, length, out lvl0, out lvl1, out lvl2, out lvl3)` — получите _потенциальные_ места по уровням образования. Эти методы документированы (через wiki Realistic Population) — и именно их патчат RP/RICO, поэтому у вас будет идеальная совместимость ([GitHub](https://github.com/algernon-A/Realistic-Population-Revisited/wiki/Harmony-patches "Harmony patches · algernon-A/Realistic-Population-Revisited Wiki · GitHub")).
        
    - Иначе (сервисы/уникальные/монументы, AI вида `HospitalAI`, `PoliceStationAI`, `FireStationAI`, `SchoolAI`, `UniqueBuildingAI`, `MonumentAI`, `PowerPlantAI` и т. п.):  
        **Стратегия чтения capacity:**
        
        1. Проверить, есть ли у AI метод `CalculateWorkplaceCount(...)` с сигнатурой как у зонированных (у ряда сервисных AIs он тоже присутствует и возвращает lvl0..lvl3).
            
        2. Если метода нет — читать сериализованные поля через reflection: многие сервисные AI хранят числа рабочих мест (иногда уже с разбивкой по уровням). Это косвенно подтверждают моды, позволяющие редактировать «число работников» у сервисов (Customize It / Customize It Extended) — значит, значения доступны через поля AI и меняются «на лету» ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=1806759255&utm_source=chatgpt.com "Customize It Extended - Workshop")).
            
        3. Фолбэк: если конкретный AI не даёт явных полей/метода, можно применить **эвристику по префабу** (например, таблица по `name`/`AI`/`size`) — как делают некоторые сообщества (есть сводные листы по сервисам) — но помечайте такие точки как «approx» и отдавайте приоритет данным из AI ([Reddit](https://www.reddit.com/r/CitiesSkylines/comments/k9ddv9/how_many_employees_in_each_service_building/?utm_source=chatgpt.com "How many employees in each service building?")).
            
    - В любом случае сохраняйте **JobsCapacityTotal** и **JobsCapacityByEdu[4]**.
        
3. **Фактическая занятость (occupancy):**
    
    - Считать число реально трудоустроенных на здание через `CitizenUnits` с флагом **Work** (как и было в изначальном плане), **но** параллельно введите счётчик **ByEdu**: суммируйте образование каждого работающего гражданина в это здание (см. ниже «Как получить образование гражданина»).
        
    - Для сервисов учитывайте, что они могут «работать» и при 0 работниках — это не баг, так устроена игра, но **occupancy** там всё равно есть (и его показывает, например, мод Building Usage) ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2048266761&utm_source=chatgpt.com "Building Usage - Workshop")).
        
4. **Жители (supply) для «housing→jobs»:**
    
    - Сканировать `CitizenUnits` типа **Home** и суммировать реальных граждан по уровням образования — это даст **EligibleResidentsByEdu[4]** для вашего тайла/района.
        

## B.2 Кэширование

- Ключ кэша для capacity — `(buildingID, building.Info, level, width, length, RP/RICO active flags)`.
    
- Отдельно кэшируйте **occupancy** с коротким TTL (вы быстро пересчитаете).
    
- Плюс мини-кэш на reflection (поля AI для сервисов) — определили однажды, переиспользуете.
    

## B.3 Триггеры пересчёта

- Таймер 5–10 **игровых** секунд — ок.
    
- События: постройка/снос, апгрейд уровня, смена зоны, **смена размера гекса** в UI, тумблер «по районам/по гексам».
    
- Если обнаружен активный Realistic Population / RICO — **инвалидируйте capacity** при загрузке сейва и при явных «наблюдаемых» изменениях (например, RICO-профили перезагружены). RP патчит `CalculateWorkplaceCount`, поэтому вызов метода уже даст актуализацию, но схема инвалидатора полезна для тяжёлых городов ([GitHub](https://github.com/algernon-A/Realistic-Population-Revisited/wiki/Harmony-patches "Harmony patches · algernon-A/Realistic-Population-Revisited Wiki · GitHub")).
    

## B.4 Интеграция

- Передавайте `JobsCapacityByEdu`, `JobsOccupancyByEdu`, `EligibleResidentsByEdu` в Aggregator (этап C) и Overlay.
    
- Логируйте отдельными блоками: `CAPACITY(zoned)`, `CAPACITY(service)`, `OCCUPANCY`, `SUPPLY(Home)`.
    

## B.5 Валидация

- Сравнить ваши **capacity** по выборке зданий с показателями из панелей/модов: _Building Usage_ показывает «сколько назначено» vs «сколько разрешено» для зданий, удобно для sanity-check’а ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2048266761&utm_source=chatgpt.com "Building Usage - Workshop")).
    
- Прогнать тесты с RP/RICO включён/выкл, чтобы убедиться, что вы берёте уже «пересчитанные» этими модами capacity (поскольку они перехватывают `CalculateWorkplaceCount`) ([GitHub](https://github.com/algernon-A/Realistic-Population-Revisited/wiki/Harmony-patches "Harmony patches · algernon-A/Realistic-Population-Revisited Wiki · GitHub")).
    

---

# Конкретные ответы на ваши 2 проблемы

## 1) «Правильные флаги образования», отказ от рандома по возрасту

- В CS1 образование граждан — **четырёхуровневое**: Uneducated / Educated / Well-educated / Highly-educated (0..3). Это официальная механика, её и используем в подсчётах баланса по образованию (для граждан и для вакансий) ([skylines.paradoxwikis.com](https://skylines.paradoxwikis.com/Education?utm_source=chatgpt.com "Education - Cities: Skylines Wiki")).
    
- Как получить **реальные уровни** у гражданина: на практике моддеры читают поле уровня образования у `Citizen` из **Assembly-CSharp.dll** (через ILSpy/dotPeek). Официальной API-страницы с полями нет, это нормально для CS1 — стандартный путь через деобфускацию кода (см. «Reverse Engineering» гайд) ([citiesskylinesmoddingguide.readthedocs.io](https://citiesskylinesmoddingguide.readthedocs.io/en/latest/modding/Workflow/Reverse-Engineering.html?utm_source=chatgpt.com "Reverse Engineering - Cities:Skylines Modding's documentation")).
    
- Рекомендация для второго ИИ:
    
    1. Напрямую читать уровень образования у `Citizen` (без «вывода по возрасту»).
        
    2. Если по какой-то причине поле недоступно (редкие билды/обфускация), **временный фолбэк** — агрегаты по зданию-работодателю (распределение занятых по edu из `CitizenUnits` Work) и городской сводке по образованию (для sanity-check'а), но это только как запасной вариант.
        

## 2) «Как получить capacity по сервисным зданиям»

- Для зонированных — **всегда** через `CalculateWorkplaceCount(...)` (это «источник истины», плюс он подменяется Realistic Population/RICO) ([GitHub](https://github.com/algernon-A/Realistic-Population-Revisited/wiki/Harmony-patches "Harmony patches · algernon-A/Realistic-Population-Revisited Wiki · GitHub")).
    
- Для сервисов/уникальных:
    
    - Сначала попытаться вызвать **аналогичный метод** у их AI (ряд классов его реализуют).
        
    - Если метода нет — **reflection по AI**: у сервисных префабов «кол-во работников» хранится в полях AI и редактируется модами (Customize It/Extended), следовательно, его можно безопасно читать и использовать как capacity (а при желании — и визуально сверять в игре) ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=1806759255&utm_source=chatgpt.com "Customize It Extended - Workshop")).
        
    - В крайнем случае — таблица-справочник (существуют сводные списки по сервисам с цифрами и требуемым edu; как ориентир) — пометьте как «approx», чтобы пользователь понимал источник данных ([Reddit](https://www.reddit.com/r/CitiesSkylines/comments/k9ddv9/how_many_employees_in_each_service_building/?utm_source=chatgpt.com "How many employees in each service building?")).
        
- Помните: сервисы **могут** функционировать без работников (игра не ругается), но для **баланса труда** их capacity следует учитывать, иначе вы недооцените спрос на рабочую силу в тайле/районе ([skylines.paradoxwikis.com](https://skylines.paradoxwikis.com/Service_buildings?utm_source=chatgpt.com "Service buildings - Cities: Skylines Wiki")).
    

---

# Маленькие, но важные тонкости

- **Сопоставление «вакансии ↔ граждане» по образованию:** вакансия уровня _k_ может быть занята гражданином уровня _≥ k_ (ваниль так и делает; RP/RICO балансируют доли через свои формулы). Поэтому при расчёте «дефицита по уровням» идите сверху вниз (highly-educated закрывают все уровни, остаток спускается ниже).
    
- **Совместимость:** не пытайтесь вручную «корректировать» цифры Realistic Population — просто вызывайте его патченые методы; это гарантирует согласованность с тем, что игрок видит в других инфовью/модах ([GitHub](https://github.com/algernon-A/Realistic-Population-Revisited/wiki/Harmony-patches "Harmony patches · algernon-A/Realistic-Population-Revisited Wiki · GitHub")).
    
- **Проверка в UI:** мод **Building Usage** хорош для верификации: он показывает «назначенных работников / разрешённых» (в т.ч. для сервисов, пример — электростанции), и распределения по образованию в сводке — можно быстро сверить ваши расчёты на выборке зданий ([steamcommunity.com](https://steamcommunity.com/sharedfiles/filedetails/?id=2048266761&utm_source=chatgpt.com "Building Usage - Workshop")).
    
- **Реверс-инжиниринг без боли:** держите под рукой ILSpy и ModTools — это «каноничный» способ заглянуть в `Assembly-CSharp.dll` и посмотреть, где конкретный AI хранит workplaces (и как он их считает) ([citiesskylinesmoddingguide.readthedocs.io](https://citiesskylinesmoddingguide.readthedocs.io/en/latest/modding/Workflow/Reverse-Engineering.html?utm_source=chatgpt.com "Reverse Engineering - Cities:Skylines Modding's documentation")).
    

Если хочешь, я превращу это в короткую «чек-лист-инструкцию» для второго ИИ (что вызывать по каждому типу здания, как сводить edu-баланс и где логировать красные флаги).